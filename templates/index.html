<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with GryBot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'chat-bg': '#181623',
                        'chat-surface': '#222438',
                        'chat-border': '#232744',
                        'bot-message': '#191A36',
                        'user-message': '#232744',
                        'accent-green': '#509246',
                        'accent-green-dark': '#447A3E',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }
        
        .message-enter {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: #222438;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background: #232744;
            border-radius: 3px;
        }
        
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #191A36;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4" style="background: linear-gradient(135deg, #181623 0%, #222438 50%, #191A36 100%);">
    <div class="w-full max-w-md mx-auto">
        <!-- Chat Container -->
        <div class="backdrop-blur-xl border rounded-2xl shadow-2xl overflow-hidden" style="background: rgba(34, 36, 56, 0.5); border-color: rgba(35, 39, 68, 0.5);">
            <!-- Header -->
            <div class="p-6 text-center relative overflow-hidden" style="background: linear-gradient(135deg, #509246 0%, #447A3E 100%);">
                <div class="absolute inset-0 bg-black/10"></div>
                <div class="relative z-10">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-white">GryBot</h1>
                    <p class="text-green-100 text-sm opacity-90">AI Assistant</p>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="chat-messages h-96 overflow-y-auto p-4 space-y-4" style="background: rgba(24, 22, 35, 0.3);" id="chat-messages">
                <!-- Welcome Message -->
                <div class="flex items-start space-x-3">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background: linear-gradient(135deg, #509246 0%, #447A3E 100%);">
                        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <div class="rounded-2xl rounded-tl-sm px-4 py-3 max-w-xs" style="background: rgba(34, 36, 56, 0.5);">
                        <p class="text-slate-200 text-sm leading-relaxed">Hello! I'm GryBot. How can I help you today?</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t" style="background: rgba(34, 36, 56, 0.5); border-color: rgba(35, 39, 68, 0.5);">
                <div class="flex items-end space-x-3">
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="user-input" 
                            placeholder="Type your message..." 
                            class="w-full border rounded-xl px-4 py-3 text-slate-200 placeholder-slate-400 focus:outline-none focus:ring-2 focus:border-green-500/50 transition-all duration-200 resize-none"
                            style="background: rgba(34, 36, 56, 0.5); border-color: rgba(35, 39, 68, 0.5); --tw-ring-color: rgba(80, 146, 70, 0.5);"
                        >
                    </div>
                    <button 
                        onclick="sendMessage()" 
                        id="send-button"
                        class="text-white p-3 rounded-xl transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                        style="background: linear-gradient(135deg, #509246 0%, #447A3E 100%); --tw-ring-color: rgba(80, 146, 70, 0.5);"
                        onmouseover="this.style.background='linear-gradient(135deg, #447A3E 0%, #509246 100%)'"
                        onmouseout="this.style.background='linear-gradient(135deg, #509246 0%, #447A3E 100%)'"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    // Check if it's the first visit and show suggestions
    document.addEventListener('DOMContentLoaded', function () {
        const chatMessages = document.getElementById('chat-messages');
        const hasInteracted = localStorage.getItem('chatHasInteracted');

        if (!hasInteracted) {
            showSuggestionQuestions(chatMessages);
        }
    });

    function showSuggestionQuestions(container) {
        const suggestions = [
            "What problem is Gryork solving?",
            "How does the CWC model work?",
            "What is NBFC and how it works?",
            "How do subcontractors get funds quickly?"
        ];

        const suggestionsDiv = document.createElement('div');
        suggestionsDiv.className = 'p-4 border-t border-chat-border text-center space-y-2';
        suggestionsDiv.id = 'suggestion-box';
        suggestionsDiv.innerHTML = `
            <p class="text-slate-300 text-sm mb-3">Ask me something:</p>
            ${suggestions.map(q => `
                <button 
                    class="inline-block bg-chat-surface hover:bg-chat-border text-slate-200 text-xs px-4 py-2 rounded-full mb-2 mr-2 transition"
                    onclick="useSuggestion(this)">
                    ${q}
                </button>
            `).join('')}
        `;
        container.appendChild(suggestionsDiv);
        container.scrollTop = container.scrollHeight;
    }

    function useSuggestion(button) {
        const query = button.textContent.trim();
        document.getElementById('user-input').value = query;
        sendMessage(); // Send automatically

        // Remove suggestions after use
        const suggestionsBox = document.getElementById('suggestion-box');
        if (suggestionsBox) suggestionsBox.remove();

        // Mark as interacted
        localStorage.setItem('chatHasInteracted', 'true');
    }

    function sendMessage() {
        const input = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const query = input.value.trim();
        if (!query) return;

        // Remove suggestions on first message (manual or via button)
        const suggestionsBox = document.getElementById('suggestion-box');
        if (suggestionsBox) {
            suggestionsBox.remove();
            localStorage.setItem('chatHasInteracted', 'true');
        }

        // Disable input and button during request
        input.disabled = true;
        sendButton.disabled = true;

        // Add user message
        addMessage(query, 'user-message');
        input.value = '';

        // Send to backend
        fetch('/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Server responded with status: ${response.status}`);
            }
            return response.text().then(text => {
                if (!text) {
                    throw new Error('Empty response received from server');
                }
                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error(`JSON parsing error: ${e.message}. Raw response: ${text.substring(0, 100)}...`);
                }
            });
        })
        .then(data => {
            if (data.error) {
                addMessage('Error: ' + data.error, 'bot-message');
            } else {
                addMessage(data.response, 'bot-message');
            }
        })
        .catch(error => {
            console.error('Error details:', error);
            addMessage('Error: ' + error.message, 'bot-message');
        })
        .finally(() => {
            // Re-enable input and button
            input.disabled = false;
            sendButton.disabled = false;
            input.focus();
        });
    }

    function addMessage(text, className) {
        const messages = document.getElementById('chat-messages');
        const messageContainer = document.createElement('div');
        
        if (className === 'user-message') {
            messageContainer.className = 'flex items-start space-x-3 justify-end message-enter';
            messageContainer.innerHTML = `
                <div class="rounded-2xl rounded-tr-sm px-4 py-3 max-w-xs" style="background: linear-gradient(135deg, #509246 0%, #447A3E 100%);">
                    <p class="text-white text-sm leading-relaxed">${text}</p>
                </div>
                <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background: linear-gradient(135deg, #509246 0%, #447A3E 100%);">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
            `;
        } else {
            messageContainer.className = 'flex items-start space-x-3 message-enter';
            messageContainer.innerHTML = `
                <div class="w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0" style="background: linear-gradient(135deg, #509246 0%, #447A3E 100%);">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                </div>
                <div class="rounded-2xl rounded-tl-sm px-4 py-3 max-w-xs" style="background: rgba(34, 36, 56, 0.5);">
                    <p class="text-slate-200 text-sm leading-relaxed">${text}</p>
                </div>
            `;
        }
        
        messages.appendChild(messageContainer);
        messages.scrollTop = messages.scrollHeight;
    }

    // Allow Enter key to send message
    document.getElementById('user-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Focus input on load
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('user-input').focus();
    });
</script>
</body>
</html>
